# Infinigen for Beginners
This repo aims to convey an understanding of the infinigen code base structure and the scene generation. Moreover, we will focus on the scene generation on a local device, so to say with computational limitations, and we especially aim to generate underwater scenes.

# üåä Generating Underwater 3D Scenes with Infinigen

This project documents the process and learnings from generating high-quality underwater 3D scenes using [Infinigen](https://github.com/princeton-vl/infinigen) and integrating them into simulation environments.

---

## üìÅ Project Overview

- **Goal**: Automatically generate photorealistic underwater scenes (kelp forests, coral reefs, canyons) for simulation and ML applications.
- **Tooling**: Infinigen + Blender + SLURM Cluster + Docker + MeshCat Simulator + CloudCompare
- **Focus**: Parameter tuning with `.gin` config files, scene export to `.obj`, and simulator integration.

---

## üõ†Ô∏è Setup & Installation

### Prerequisites

- Python 3.11  
- Blender ‚â• 3.6  
- CUDA GPU or Metal (on macOS)  
- FFmpeg for video rendering  
- Disk space: >20GB recommended  

### Setup

Clone the repository and install dependencies:

```bash
git clone https://github.com/princeton-vl/infinigen.git
cd infinigen
pip install -r requirements.txt
python scripts/download_assets.py
```

### Cluster (SLURM) & Docker

- Docker is used for GPU access inside the cluster.  
- CUDA setup inside container is required for GPU rendering.

---

## üß™ Scene Generation Pipeline

We used two primary scripts:

- `generate_nature.py`: Standalone pipeline  
- `manage_jobs.py`: Batch job control on cluster  

Each scene uses a chain of Gin-configurable stages:

```python
compose_nature  # Layout objects (empty placeholders)
populate_scene  # Replace placeholders with assets
```

### Example command:

```bash
python -m infinigen.datagen.manage_jobs \
  --output_folder outputs/kelp_forest_world \
  --num_scenes 1 \
  --configs kelp_forest.gin \
  --pipeline_configs local_16GB.gin monocular_video.gin \
  --pipeline_overrides LocalScheduleHandler.use_gpu=True
```

---

## ‚öôÔ∏è Key Gin Parameters

```gin
compose_nature.kelp_chance = 1.0
compose_nature.creatures_chance = 0.0
compose_nature.fish_school_chance = 0.3
water.shader.volume_density = ("uniform", 0.09, 0.13)
camera.camera_pose_proposal.pitch = ("clip_gaussian", 90, 15, 60, 140)
```

See `configs/scene_types/under_water.gin` and `kelp_forest.gin` for full setups.

---

## üß± Troubleshooting & Insights

| Problem | Cause | Fix |
|--------|-------|-----|
| `RuntimeError: No space left on device` | Blender failed to save `.blend` | Clear disk space |
| Kelp scene crashing | Low `kelp_chance` (e.g. 0.7) | Use `kelp_chance = 1.0` |
| Camera sees placeholders only | Blender camera was moved manually | Re-run scene with new camera pose |
| Massive `.obj` files (20GB+) | Too many assets or large bounds | Reduce resolution & bounding box |
| Objects black in simulator | Missing textures or shading | Export only with vertex color; simplify mesh |
| `"Could not find 1 camera views"` | Bounds too small | Increase `Terrain.bounds` and camera range |

---

## üì¶ Exporting to External Simulators

Export `.blend` to `.obj`:

```bash
python -m infinigen.tools.export \
  --input_folder outputs/kelp_forest_world/0/fine \
  --output_folder exports/kelp_forest \
  -f obj -r 256
```

**Tips**:
- Remove atmospheric objects from `.blend` before export.  
- Exporting low-asset scenes reduces file size significantly.

---

## üß≠ Simulator Integration

- Tested with **Stonefish** and **Bluerov2 Gym (Meshcat)**
- Exported `.obj` or `.dae` files are loaded, but complex scenes may break visualization
- Downscale scene bounds or convert to `.glb` for animation support

---

## üß† Insights

- Infinigen is highly modular; each scene is generated by stages driven by `RandomStageExecutor`.
- The chance-based system lets you probabilistically include elements.
- The main tradeoff is between visual richness and output manageability (render time, file size).

---

## üé• Rendering & Videos

Use FFmpeg to convert frames:

```bash
ffmpeg -framerate 30 -i %04d.png -c:v libx264 -pix_fmt yuv420p output.mp4
```

---

## üìà Optimizing for Speed

Use `static.gin` with:

```gin
iterate_scene_tasks.frame_range = [1, 1]
iterate_scene_tasks.render_frame_range = [1, 1]
```

This reduced rendering time from 15 min ‚Üí 2 min.

---

## üìé References

- [Infinigen GitHub](https://github.com/princeton-vl/infinigen)  
- [GIN Config Library](https://github.com/google/gin-config)  
- [Exporting to External Formats](https://github.com/princeton-vl/infinigen/blob/main/docs/ExportingToExternalFileFormats.md)  
- [Bluerov2 Gym (Meshcat)](https://github.com/gokulp01/bluerov2_gym)
